import{parse as parseUrl,format as formatUrl,fileURLToPath,pathToFileURL}from"url";import{extname,join}from"path";async function getTracer(){const t=global.$_$tracer;if(t&&t._esm&&t._esm.quokkaSettings&&!t._esm.initialized)if(t._esm.tsNode)t._esm.initialized=!0;else{t._esm.initialized=!0;try{const e=t._esm.quokkaSettings;if(e.ts){let s=e.ts.tsNode.ignore||["(?:^|/)node_modules/"];s=Array.isArray(s)?s:[s],s.push(t._esm.serverPath);const r={compiler:process.env.TS_NODE_COMPILER,ignore:s};e.nativeEsm&&(r.experimentalEsmLoader=!0,r.transpileOnly=!0);const o=e.ts.tsNode.path,i=await import(join(e.ts.tsNode.path,"dist","index.js")),a=i.register(r);if(e.nativeEsm){const e=await import("semver");if(t._esm.tsNode=a,e.gte(i.VERSION,"10.8.0")){const e=join(o,"/dist-raw/node-internal-modules-esm-resolve.js"),s=await import(e),r=await import(join(o,"/dist/file-extensions.js")).getExtensions(a.config,a.options,a.ts.version);t._esm.tsNodeResolve=s.createResolve({extensions:r,preferTsExts:a.options.preferTsExts,tsNodeExperimentalSpecifierResolution:a.options.experimentalSpecifierResolution})}else{const e=join(o,"/dist-raw/node-esm-resolve-implementation.js"),s=await import(e),r=i.getExtensions(a.config);r.preferTsExts=a.options.preferTsExts,t._esm.tsNodeResolve=s.createResolve(r)}}try{if(e.ts.tsconfigPaths&&e.nativeEsm)try{const s=await import(e.ts.tsconfigPaths.path);if(e.ts.compilerOptions&&e.ts.compilerOptions.baseUrl&&e.ts.compilerOptions.paths)t._esm.tsConfigPathsMatchPath=s.createMatchPath(e.ts.compilerOptions.baseUrl,e.ts.compilerOptions.paths);else{const{absoluteBaseUrl:e,paths:r}=s.loadConfig();t._esm.tsConfigPathsMatchPath=s.createMatchPath(e,r)}}catch(t){}}catch(t){}}}catch(t){}}return t}export async function getSource(t,e,s){const r=await getTracer();if(r&&r._esm){const e=r._esm;if(t===e.scratchFileUrl)return{source:e.scratchFileContent}}return s(t,e,s)}export async function resolve(t,e,s){const r=await getTracer();if(r&&r._esm){const o=r._esm,i=o.scratchFileUrl;if(t===i)return{url:i,shortCircuit:!0};if(t.startsWith("file:")||t.startsWith("data:")||t.startsWith(".")){if(t.startsWith(".")||t.startsWith("file:")){let i,a=`${t}?session=${global.$_$session}`;const n=o.tsNodeResolve;try{i=n?await n.defaultResolve(a,e,s):await s(a,e,s)}catch(r){if(!n||t.endsWith(".js")||t.endsWith(".ts"))throw r;try{a=`${t}.ts?session=${global.$_$session}`,i=await n.defaultResolve(a,e,s)}catch(t){throw r}}return r._doWhenReceiverIsReady((()=>{r._send("module",{path:fileURLToPath(i.url)})})),{...i,shortCircuit:!0}}}else{const r=o.localProjectDirUrl;if(e.parentURL.startsWith(r)){const i=e.parentURL;try{return await s(t,e,s)}catch(a){if("ERR_MODULE_NOT_FOUND"!==a.code)throw a;try{return e.parentURL=i.replace(r,o.tempDirUrl),await s(t,e,s)}catch(a){if("ERR_MODULE_NOT_FOUND"!==a.code)throw a;try{return e.parentURL=i.replace(r,o.settingsDirUrl),await s(t,e,s)}catch(r){if("ERR_MODULE_NOT_FOUND"!==r.code||!o.tsNodeResolve)throw r;{let a;e.parentURL=i;try{a=o.tsNodeResolve.defaultResolve(t,e,s).url}catch(t){}const n=async r=>{if("ERR_MODULE_NOT_FOUND"===r.code){if(t.endsWith(".js"))return resolve(t.substring(0,t.length-3),e,s);if(o.tsConfigPathsMatchPath){const i=o.tsConfigPathsMatchPath(t);if(i)return resolve(i,e,s);throw r}throw r}throw r};if(!a)return n(r);try{return resolve(a,e,s)}catch(t){return n(t)}}}}}}}}return s(t,e,s)}export async function getFormat(t,e,s){const r=await getTracer();if(r&&r._esm){const o=r._esm;if(t===o.scratchFileUrl)return{format:"module"};const i=o.tsNode;if(i){const r=parseUrl(t);if((null===r.protocol||"file:"===r.protocol)&&!r.hostname){const r=fileURLToPath(t);let o;if(o=".js"===extname(r)||i.ignored(r)?await s(t,e,s):await s(formatUrl(pathToFileURL(r+".js")),e,s),!i.ignored(r)&&("commonjs"===o.format||"module"===o.format)){const{moduleType:t}=(i.moduleTypeClassifier.classifyModule||i.moduleTypeClassifier.classifyModuleByModuleTypeOverrides)(r.replace(/\\/g,"/"));if("cjs"===t)return{format:"commonjs"};if("esm"===t)return{format:"module"}}return o}}}return s(t,e,s)}export async function transformSource(t,e,s){const r=await getTracer();if(r&&r._esm){const s=r._esm;if(e.url===s.scratchFileUrl)return{source:t};const o=s.tsNode;if(o){t="string"==typeof t?t:t.toString("utf8");const s=parseUrl(e.url);if(null===s.protocol||"file:"===s.protocol){const s=fileURLToPath(e.url);if(!o.ignored(s))return{source:o.compile(t,s)}}}}return s(t,e,s)}